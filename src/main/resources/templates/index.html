<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея изображений</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/gallery.css">
</head>
<body>

<script th:inline="javascript">
    /*<![CDATA[*/
    window.userData = {
        isAuthenticated: /*[[${#authorization.expression('isAuthenticated()')}]]*/ false,
        userId: /*[[${#authentication.principal != null && #authentication.principal != 'anonymousUser' ? #authentication.principal.id : null}]]*/ null,
        username: /*[[${#authentication.name}]]*/ null,
        isAdmin: /*[[${#authorization.expression('hasRole(''ROLE_ADMIN'')')}]]*/ false
    };
    /*]]>*/
</script>

<div th:replace="~{fragments/header :: header}"></div>

<div class="content-container">
    <!-- Фильтр категорий -->
    <div class="filter-container">
        <label for="categoryFilter">Фильтр по категории:</label>
        <select id="categoryFilter" onchange="filterByCategory()">
            <option value="">Все категории</option>
            <option th:each="category : ${categories}"
                    th:value="${category.id}"
                    th:text="${category.name}"></option>
        </select>
    </div>

    <div class="gallery" id="gallery">
        <div th:if="${#lists.isEmpty(images)}" class="loading">
            Нет изображений для отображения
        </div>
        <div th:each="image, stat : ${images}"
             class="image-card"
             th:data-id="${image.id}"
             th:data-index="${stat.index}"
             th:attr="data-category-id=${image.category?.id ?: ''},
                  data-description=${image.description},
                  data-category-name=${image.category?.name}">
            <img th:src="@{'/uploads/' + ${image.imagePath}}"
                 th:alt="${image.title}">
            <div th:text="${image.title}">Название</div>
        </div>
    </div>
</div>

<div class="modal" id="imageModal">
    <div class="modal-container">
        <div class="modal-content-wrapper">
            <!-- Изображение и основная информация -->
            <div class="image-main-content">
                <img class="modal-content" id="modalImage">

                <div class="image-info-container">
                    <div class="image-category-modal" id="modalCategory"></div>
                    <div class="image-description" id="modalDescription"></div>
                </div>
            </div>

            <!-- Комментарии -->
            <div class="comments-section" id="commentsSection">
                <h4>Комментарии</h4>
                <div id="commentsList" class="comments-list-container"></div>

                <div th:if="${#authorization.expression('isAuthenticated()')}" class="comment-form">
                    <textarea id="commentText" class="comment-textarea" placeholder="Добавить комментарий..."></textarea>
                    <button onclick="addComment()" class="comment-submit">Отправить</button>
                </div>

                <div th:unless="${#authorization.expression('isAuthenticated()')}" class="comment-login-prompt">
                    <a href="/login">Войдите</a>, чтобы увидеть или оставить комментарии
                </div>
            </div>
        </div>
    </div>
    <span class="close">&times;</span>
    <span class="modal-nav prev">&lt;</span>
    <span class="modal-nav next">&gt;</span>
</div>

<script>
    let currentImageId = null;
    let currentIndex = 0;
    let images = [];
    let modalOpen = false;

    let currentUserId = window.userData.userId;
    let isAdmin = window.userData.isAdmin;

    console.log('Данные пользователя из Thymeleaf:', window.userData);

    function initGallery() {
        const imageCards = document.querySelectorAll('.image-card');
        images = Array.from(imageCards).map(card => ({
            id: card.getAttribute('data-id'),
            title: card.querySelector('div').textContent,
            imagePath: card.querySelector('img').src.split('/uploads/')[1],
            description: card.getAttribute('data-description') || '',
            categoryId: card.getAttribute('data-category-id') || '',
            categoryName: card.getAttribute('data-category-name') || ''
        }));

        imageCards.forEach((card, index) => {
            card.addEventListener('click', () => openImageModal(index));
        });
    }

    function openImageModal(index) {
        currentIndex = index;
        showImage(images[currentIndex]);
        document.getElementById('imageModal').style.display = 'block';
        modalOpen = true;
    }

    function showImage(image) {
        const modalImage = document.getElementById('modalImage');
        const modalCategory = document.getElementById('modalCategory');
        const modalDescription = document.getElementById('modalDescription');

        modalImage.src = '/uploads/' + image.imagePath;

        if (image.categoryName && image.categoryName.trim() !== '') {
            modalCategory.textContent = 'Категория: ' + image.categoryName;
            modalCategory.style.display = 'inline-block';
        } else {
            modalCategory.style.display = 'none';
        }

        if (image.description && image.description.trim() !== '') {
            modalDescription.textContent = image.description;
            modalDescription.style.display = 'block';
        } else {
            modalDescription.style.display = 'none';
        }

        currentImageId = image.id;
        loadComments(currentImageId);
    }

    function showPrevImage() {
        if (!modalOpen || images.length === 0) return;
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        showImage(images[currentIndex]);
    }

    function showNextImage() {
        if (!modalOpen || images.length === 0) return;
        currentIndex = (currentIndex + 1) % images.length;
        showImage(images[currentIndex]);
    }

    async function loadComments(imageId) {
        try {
            const response = await fetch(`/api/comments/image/${imageId}`);
            if (response.ok) {
                const comments = await response.json();
                displayComments(comments);
            }
        } catch (error) {
            console.error('Ошибка загрузки комментариев:', error);
        }
    }

    function displayComments(comments) {
        const commentsList = document.getElementById('commentsList');
        commentsList.innerHTML = '';

        if (!comments || comments.length === 0) {
            commentsList.innerHTML = '<p class="no-comments">Комментариев пока нет</p>';
            return;
        }

        console.log('Текущий пользователь ID:', currentUserId);
        console.log('isAdmin:', isAdmin);
        console.log('Комментарии:', comments);

        comments.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';

            const canDelete = currentUserId && (isAdmin || currentUserId === comment.userId);

            commentDiv.innerHTML = `
            <div class="comment-header">
                <span class="comment-author">${comment.username}</span>
                <span class="comment-date">${new Date(comment.createdAt).toLocaleString()}</span>
            </div>
            <div class="comment-text">${comment.text}</div>
            ${canDelete ?
                `<div class="comment-actions">
                    <button onclick="deleteComment(${comment.id})" class="comment-delete">Удалить</button>
                </div>`
                : ''
            }
        `;
            commentsList.appendChild(commentDiv);
        });
    }

    async function addComment() {
        const commentText = document.getElementById('commentText').value.trim();

        if (!commentText) {
            alert('Введите текст комментария');
            return;
        }

        try {
            const response = await fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: commentText,
                    image: { id: currentImageId }
                })
            });

            if (response.ok) {
                document.getElementById('commentText').value = '';
                loadComments(currentImageId);
            } else {
                alert('Ошибка при добавлении комментария');
            }
        } catch (error) {
            alert('Ошибка сети');
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('Удалить комментарий?')) return;

        try {
            const response = await fetch(`/api/comments/${commentId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadComments(currentImageId);
            } else {
                alert('Ошибка при удалении комментария');
            }
        } catch (error) {
            alert('Ошибка сети');
        }
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
        modalOpen = false;
    }

    function filterByCategory() {
        const selectedCategoryId = document.getElementById('categoryFilter').value;
        const imageCards = document.querySelectorAll('.image-card');

        imageCards.forEach(card => {
            const cardCategoryId = card.getAttribute('data-category-id');
            if (!selectedCategoryId || cardCategoryId === selectedCategoryId) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Данные пользователя:', window.userData);
        initGallery();
    });

    // Обработчики событий
    document.querySelector('.prev').addEventListener('click', showPrevImage);
    document.querySelector('.next').addEventListener('click', showNextImage);
    document.querySelector('.close').addEventListener('click', closeModal);

    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    document.addEventListener('keydown', (event) => {
        if (!modalOpen) return;
        switch(event.key) {
            case 'Escape':
                closeModal();
                break;
            case 'ArrowLeft':
                showPrevImage();
                break;
            case 'ArrowRight':
                showNextImage();
                break;
        }
    });
    document.addEventListener('DOMContentLoaded', initGallery);
</script>
</body>
</html>