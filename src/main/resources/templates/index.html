<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Галерея изображений</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/gallery.css">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="content-container">
    <!-- Фильтр категорий -->
    <div class="filter-container" style="margin-bottom: 20px; text-align: center;">
        <label for="categoryFilter" style="margin-right: 10px;">Фильтр по категории:</label>
        <select id="categoryFilter" onchange="filterByCategory()" style="padding: 8px; border-radius: 4px;">
            <option value="">Все категории</option>
            <option th:each="category : ${categories}"
                    th:value="${category.id}"
                    th:text="${category.name}"></option>
        </select>
    </div>

    <div class="gallery" id="gallery">
        <div th:if="${#lists.isEmpty(images)}" class="loading">
            Нет изображений для отображения
        </div>
        <div th:each="image, stat : ${images}"
             class="image-card"
             th:data-id="${image.id}"
             th:data-index="${stat.index}"
             th:attr="data-category-id=${image.category?.id ?: ''},
                  data-description=${image.description},
                  data-category-name=${image.category?.name}"> <!-- Добавляем название категории -->
            <img th:src="@{'/uploads/' + ${image.imagePath}}"
                 th:alt="${image.title}">
            <div th:text="${image.title}">Название</div>
        </div>
    </div>
</div>

<div class="modal" id="imageModal">
    <div class="modal-container">
        <div class="modal-content-wrapper">
            <img class="modal-content" id="modalImage">

            <div class="image-category-modal" id="modalCategory"></div>

            <div class="image-description" id="modalDescription"></div>
        </div>
    </div>
    <span class="close">&times;</span>
    <span class="modal-nav prev">&lt;</span>
    <span class="modal-nav next">&gt;</span>
</div>

<script>
    let currentIndex = 0;
    let images = [];
    let modalOpen = false;

    function initGallery() {
        const imageCards = document.querySelectorAll('.image-card');
        images = Array.from(imageCards).map(card => ({
            id: card.getAttribute('data-id'),
            title: card.querySelector('div').textContent,
            imagePath: card.querySelector('img').src.split('/uploads/')[1],
            description: card.getAttribute('data-description') || '',
            categoryId: card.getAttribute('data-category-id') || '',
            categoryName: card.getAttribute('data-category-name') || '' // Берем из data-атрибута
        }));

        imageCards.forEach((card, index) => {
            card.addEventListener('click', () => openImageModal(index));
        });
    }

    function openImageModal(index) {
        currentIndex = index;
        showImage(images[currentIndex]);
        document.getElementById('imageModal').style.display = 'block';
        modalOpen = true;
    }

    function showImage(image) {
        const modalImage = document.getElementById('modalImage');
        const modalCategory = document.getElementById('modalCategory');
        const modalDescription = document.getElementById('modalDescription');

        modalImage.src = '/uploads/' + image.imagePath;

        if (image.categoryName && image.categoryName.trim() !== '') {
            modalCategory.textContent = 'Категория: ' + image.categoryName;
            modalCategory.style.display = 'block';
        } else {
            modalCategory.style.display = 'none';
        }

        if (image.description && image.description.trim() !== '') {
            modalDescription.textContent = image.description;
            modalDescription.style.display = 'block';
        } else {
            modalDescription.style.display = 'none';
        }
    }

    function showPrevImage() {
        if (!modalOpen || images.length === 0) return;
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        showImage(images[currentIndex]);
    }

    function showNextImage() {
        if (!modalOpen || images.length === 0) return;
        currentIndex = (currentIndex + 1) % images.length;
        showImage(images[currentIndex]);
    }

    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
        modalOpen = false;
    }

    // Фильтрация по категориям
    function filterByCategory() {
        const selectedCategoryId = document.getElementById('categoryFilter').value;
        const imageCards = document.querySelectorAll('.image-card');

        imageCards.forEach(card => {
            const cardCategoryId = card.getAttribute('data-category-id');

            if (!selectedCategoryId || cardCategoryId === selectedCategoryId) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    document.querySelector('.prev').addEventListener('click', showPrevImage);
    document.querySelector('.next').addEventListener('click', showNextImage);
    document.querySelector('.close').addEventListener('click', closeModal);

    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    document.addEventListener('keydown', (event) => {
        if (!modalOpen) return;
        switch(event.key) {
            case 'Escape':
                closeModal();
                break;
            case 'ArrowLeft':
                showPrevImage();
                break;
            case 'ArrowRight':
                showNextImage();
                break;
        }
    });

    document.addEventListener('DOMContentLoaded', initGallery);
</script>
</body>
</html>