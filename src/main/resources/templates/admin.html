<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="scroll-container">
    <div class="section">
        <h1>Администрирование</h1>
        <div th:if="${error != null}" class="error-message" th:text="${error}"></div>
    </div>

    <!-- Пользователи -->
    <div class="section">
        <h2>Управление пользователями</h2>
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th class="id-column">ID</th>
                    <th class="name-column">Логин</th>
                    <th class="description-column">Email</th>
                    <th class="category-column">Роль</th>
                    <th class="actions-column">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${users}">
                    <td class="id-column" th:text="${user.id}"></td>
                    <td class="name-column">
                        <span class="truncate" th:text="${user.username}"></span>
                    </td>
                    <td class="description-column">
                        <span class="truncate" th:text="${user.email}"></span>
                    </td>
                    <td class="category-column">
                        <select th:id="'role-' + ${user.id}" th:attr="data-original-role=${user.role}" class="role-select">
                            <option th:if="${user.role.toString() == 'ROLE_USER'}"
                                    value="ROLE_USER" selected>USER</option>
                            <option th:unless="${user.role.toString() == 'ROLE_USER'}"
                                    value="ROLE_USER">USER</option>
                            <option th:if="${user.role.toString() == 'ROLE_ADMIN'}"
                                    value="ROLE_ADMIN" selected>ADMIN</option>
                            <option th:unless="${user.role.toString() == 'ROLE_ADMIN'}"
                                    value="ROLE_ADMIN">ADMIN</option>
                        </select>
                    </td>
                    <td class="actions-column">
                        <div class="actions">
                            <button class="btn btn-update" th:onclick="'updateUserRole(' + ${user.id} + ')'">Обновить роль</button>
                            <button class="btn btn-delete" th:onclick="'deleteUser(' + ${user.id} + ')'">Удалить</button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Изображения -->
    <div class="section">
        <h2>Все изображения</h2>
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th class="id-column">ID</th>
                    <th class="name-column">Название</th>
                    <th class="description-column">Описание</th>
                    <th class="author-column">Автор</th>
                    <th class="category-column">Категория</th>
                    <th class="preview-column">Превью</th>
                    <th class="actions-column">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="image : ${images}">
                    <td class="id-column" th:text="${image.id}"></td>
                    <td class="name-column">
                        <span class="truncate" th:text="${image.title}"></span>
                    </td>
                    <td class="description-column">
                        <div class="multiline">
                            <span th:if="${image.description}" th:text="${image.description}"></span>
                            <span th:unless="${image.description}" style="color: #999; font-style: italic;">Нет описания</span>
                        </div>
                    </td>
                    <td class="author-column">
                        <span class="truncate" th:if="${image.user != null}" th:text="${image.user.username}"></span>
                        <span th:unless="${image.user != null}" style="color: #999;">Unknown</span>
                    </td>
                    <td class="category-column">
                        <span class="truncate" th:if="${image.category?.name}" th:text="${image.category.name}"></span>
                        <span th:unless="${image.category?.name}" style="color: #999;">Без категории</span>
                    </td>
                    <td class="preview-column">
                        <img th:src="@{'/uploads/' + ${image.imagePath}}"
                             class="preview-img" alt="Превью"
                             onerror="this.style.display='none'">
                    </td>
                    <td class="actions-column">
                        <div class="actions">
                            <a th:href="@{/edit-image(id=${image.id}, from='admin')}" class="btn btn-update">Редактировать</a>
                            <button class="btn btn-delete" th:onclick="'deleteImage(' + ${image.id} + ')'">Удалить</button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Категории -->
    <div class="section">
        <h2>Управление категориями</h2>

        <div class="category-form">
            <h3>Добавить категорию</h3>
            <div id="categoryMessage"></div>
            <div class="category-form-row">
                <input type="text" id="categoryName" placeholder="Введите название категории" class="category-form-input">
                <button class="btn btn-update category-form-button" onclick="addCategory()">Добавить категорию</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th class="id-column">ID</th>
                    <th class="name-column">Название</th>
                    <th class="category-column">Кол-во изображений</th>
                    <th class="actions-column">Действия</th>
                </tr>
                </thead>
                <tbody id="categoriesTable">
                <tr th:each="category : ${categories}">
                    <td class="id-column" th:text="${category.id}"></td>
                    <td class="name-column">
                        <div class="category-edit-container">
                            <span th:text="${category.name}"
                                  th:id="'categoryName-' + ${category.id}"
                                  class="category-name truncate"></span>
                            <input type="text" th:value="${category.name}"
                                   th:id="'categoryInput-' + ${category.id}"
                                   class="category-input"
                                   style="display: none;"
                                   th:attr="onkeypress='if(event.keyCode==13) saveCategory(${category.id})'">
                        </div>
                    </td>
                    <td class="category-column">
                        <span class="image-count" th:text="${categoryImageCounts.get(category.id)}"></span>
                    </td>
                    <td class="actions-column">
                        <div class="actions">
                            <button class="btn btn-update"
                                    th:onclick="'editCategory(' + ${category.id} + ')'"
                                    th:id="'editBtn-' + ${category.id}">Редактировать</button>
                            <button class="btn btn-save"
                                    th:onclick="'saveCategory(' + ${category.id} + ')'"
                                    th:id="'saveBtn-' + ${category.id}"
                                    style="display: none;">Сохранить</button>
                            <button class="btn btn-delete"
                                    th:onclick="'deleteCategory(' + ${category.id} + ')'">Удалить</button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Обновление роли пользователя
    async function updateUserRole(userId) {
        const roleSelect = document.getElementById('role-' + userId);
        const originalRole = roleSelect.getAttribute('data-original-role');
        const newRole = roleSelect.value;

        try {
            const response = await fetch('/api/admin/users/' + userId + '/role?role=' + newRole, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                showMessage('Роль пользователя успешно обновлена', 'success');
                roleSelect.setAttribute('data-original-role', newRole);
            } else {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    showMessage(errorData.error, 'error');
                    roleSelect.value = originalRole;
                } catch {
                    showMessage('Ошибка при обновлении роли', 'error');
                    roleSelect.value = originalRole;
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('Ошибка сети при обновлении роли', 'error');
            roleSelect.value = originalRole;
        }
    }

    // Удаление пользователя
    async function deleteUser(userId) {
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            try {
                const response = await fetch('/api/admin/users/' + userId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Пользователь успешно удален', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        showMessage(errorData.error, 'error');
                    } catch {
                        showMessage('Ошибка при удалении пользователя', 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Ошибка сети при удалении пользователя', 'error');
            }
        }
    }

    // Удаление изображения
    async function deleteImage(imageId) {
        if (confirm('Вы уверены, что хотите удалить это изображение?')) {
            try {
                const response = await fetch('/api/admin/images/' + imageId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Изображение успешно удалено', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        showMessage(errorData.error, 'error');
                    } catch {
                        showMessage('Ошибка при удалении изображения', 'error');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Ошибка сети при удалении изображения', 'error');
            }
        }
    }

    // Добавление категории
    async function addCategory() {
        const nameInput = document.getElementById('categoryName');
        const name = nameInput.value.trim();
        const messageDiv = document.getElementById('categoryMessage');

        if (!name) {
            showMessage('Введите название категории', 'error', messageDiv);
            return;
        }

        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name
                })
            });

            if (response.ok) {
                showMessage('Категория успешно добавлена', 'success', messageDiv);
                nameInput.value = '';
                setTimeout(() => location.reload(), 1000);
            } else {
                const errorText = await response.text();
                let errorMessage = 'Ошибка добавления категории';

                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorMessage;
                } catch {
                    errorMessage = errorText || errorMessage;
                }

                showMessage(errorMessage, 'error', messageDiv);
            }
        } catch (error) {
            showMessage('Ошибка сети: ' + error.message, 'error', messageDiv);
        }
    }

    // Редактирование категории
    function editCategory(categoryId) {
        document.getElementById('categoryName-' + categoryId).style.display = 'none';
        document.getElementById('categoryInput-' + categoryId).style.display = 'block';
        document.getElementById('categoryInput-' + categoryId).focus();

        document.getElementById('editBtn-' + categoryId).style.display = 'none';
        document.getElementById('saveBtn-' + categoryId).style.display = 'inline-block';
    }

    // Сохранение категории
    async function saveCategory(categoryId) {
        const messageContainer = document.getElementById('categoryMessage');
        const newName = document.getElementById('categoryInput-' + categoryId).value.trim();

        if (!newName) {
            showMessage('Введите название категории', 'error', messageContainer);
            return;
        }

        try {
            const response = await fetch('/api/admin/categories/' + categoryId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: newName
                })
            });

            if (response.ok) {
                document.getElementById('categoryName-' + categoryId).textContent = newName;
                document.getElementById('categoryName-' + categoryId).style.display = 'block';
                document.getElementById('categoryInput-' + categoryId).style.display = 'none';
                document.getElementById('editBtn-' + categoryId).style.display = 'inline-block';
                document.getElementById('saveBtn-' + categoryId).style.display = 'none';

                showMessage('Категория успешно обновлена', 'success', messageContainer);
            } else {
                const errorText = await response.text();
                let errorMessage = 'Ошибка при обновлении категории';

                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorMessage;
                } catch {
                    errorMessage = errorText || errorMessage;
                }

                showMessage(errorMessage, 'error', messageContainer);
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('Ошибка сети при обновлении категории', 'error', messageContainer);
        }
    }

    // Удаление категории
    async function deleteCategory(categoryId) {
        const messageContainer = document.getElementById('categoryMessage');

        if (confirm('Вы уверены, что хотите удалить эту категорию?')) {
            try {
                const response = await fetch('/api/admin/categories/' + categoryId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Категория успешно удалена', 'success', messageContainer);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Ошибка при удалении категории';

                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch {
                        errorMessage = errorText || errorMessage;
                    }

                    showMessage(errorMessage, 'error', messageContainer);
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Ошибка при удалении категории', 'error', messageContainer);
            }
        }
    }

    // Вспомогательная функция для показа сообщений
    function showMessage(message, type, container = null) {
        let messageContainer = container;

        if (!messageContainer) {
            const firstSection = document.querySelector('.section');
            messageContainer = firstSection;
        }

        const oldMessages = messageContainer.querySelectorAll('.temp-message');
        oldMessages.forEach(msg => msg.remove());

        const messageElement = document.createElement('div');
        messageElement.className = type === 'success' ? 'success-message' : 'error-message';
        messageElement.classList.add('temp-message');
        messageElement.textContent = message;

        if (container && container.id === 'categoryMessage') {
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageElement);
        } else {
            const h1 = messageContainer.querySelector('h1');
            if (h1 && h1.nextSibling) {
                messageContainer.insertBefore(messageElement, h1.nextSibling);
            } else {
                messageContainer.appendChild(messageElement);
            }
        }

        setTimeout(() => {
            if (messageElement.parentNode) {
                messageElement.remove();
            }
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const categoryInput = document.getElementById('categoryName');
        if (categoryInput) {
            categoryInput.addEventListener('keypress', function(e) {
                if (e.keyCode === 13) {
                    addCategory();
                }
            });
        }
    });
</script>
</body>
</html>