<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактировать изображение</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/image-forms.css">
    <style>
        .category-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .category-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
        }
        .category-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="image-form-container">
    <a th:href="${from == 'admin' ? '/admin' : '/profile'}"
       class="image-back-link">← Назад</a>
    <div class="image-form-header">
        <h2>Редактировать изображение</h2>
    </div>

    <div id="errorMessage" class="image-error-message" style="display: none;"></div>

    <form id="editForm" enctype="multipart/form-data">
        <input type="hidden" id="imageId" th:value="${image.id}">
        <input type="hidden" id="currentCategoryId" th:value="${image.category?.id ?: ''}" />

        <div class="image-form-group">
            <label for="title">Название:</label>
            <input type="text" id="title" name="title" class="image-form-control"
                   th:value="${image.title}" required placeholder="Введите название">
        </div>

        <div class="image-form-group">
            <label for="description">Описание:</label>
            <textarea id="description" name="description" class="image-form-control image-form-textarea"
                      placeholder="Введите описание" th:text="${image.description}"></textarea>
        </div>

        <div class="image-form-group">
            <label for="category">Категория:</label>
            <div style="display: flex; gap: 10px;">
                <select id="category" name="categoryId" class="image-form-control" style="flex: 1;">
                    <option value="">Без категории</option>
                </select>
                <button type="button" class="image-btn image-btn-secondary" onclick="showCreateCategoryModal()" style="white-space: nowrap;">
                    + Создать
                </button>
            </div>
        </div>

        <div class="image-form-group">
            <label>Текущее изображение:</label>
            <img th:src="@{'/uploads/' + ${image.imagePath}}"
                 th:alt="${image.title}" class="image-current-preview">
        </div>

        <div class="image-form-group">
            <label for="file">Новое изображение:</label>
            <input type="file" id="file" name="file" class="image-form-control"
                   accept="image/*">
            <p class="image-file-hint">Оставьте пустым, чтобы сохранить текущее изображение</p>
        </div>

        <div>
            <button type="submit" class="image-btn image-btn-primary">Сохранить</button>
            <a href="/profile" class="image-btn image-btn-secondary">Отмена</a>
        </div>
    </form>
</div>

<!-- Модальное окно для создания категории -->
<div id="createCategoryModal" class="category-modal">
    <div class="category-modal-content">
        <h3>Создать новую категорию</h3>
        <div class="image-form-group">
            <label for="newCategoryName">Название категории:</label>
            <input type="text" id="newCategoryName" class="image-form-control" placeholder="Введите название">
        </div>
        <div class="category-actions">
            <button type="button" class="image-btn image-btn-secondary" onclick="hideCreateCategoryModal()">Отмена</button>
            <button type="button" class="image-btn image-btn-primary" onclick="createCategory()">Создать</button>
        </div>
    </div>
</div>

<script>
    // Загрузка категорий с установкой текущей
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            if (!response.ok) throw new Error('Ошибка загрузки категорий');

            const categories = await response.json();
            const categorySelect = document.getElementById('category');
            const currentCategoryId = document.getElementById('currentCategoryId').value;

            while (categorySelect.children.length > 1) {
                categorySelect.removeChild(categorySelect.lastChild);
            }

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            if (currentCategoryId) {
                categorySelect.value = currentCategoryId;
            }
        } catch (error) {
            console.error('Ошибка загрузки категорий:', error);
        }
    }

    // Функции для модального окна
    function showCreateCategoryModal() {
        document.getElementById('createCategoryModal').style.display = 'block';
        document.getElementById('newCategoryName').value = '';
    }

    function hideCreateCategoryModal() {
        document.getElementById('createCategoryModal').style.display = 'none';
    }

    // Создание категории
    async function createCategory() {
        const categoryName = document.getElementById('newCategoryName').value.trim();

        if (!categoryName) {
            alert('Введите название категории');
            return;
        }

        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: categoryName })
            });

            if (response.ok) {
                const newCategory = await response.json();
                hideCreateCategoryModal();

                await loadCategories();
                document.getElementById('category').value = newCategory.id;

                alert('Категория создана успешно!');
            } else {
                const errorText = await response.text();
                alert('Ошибка создания категории: ' + errorText);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка сети при создании категории');
        }
    }

    // Обработка формы редактирования
    document.getElementById('editForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const imageId = document.getElementById('imageId').value;
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const categorySelect = document.getElementById('category');
        const fileInput = document.getElementById('file');
        const errorMessage = document.getElementById('errorMessage');

        errorMessage.style.display = 'none';

        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);

        if (categorySelect.value) {
            formData.append('categoryId', categorySelect.value);
        }

        if (fileInput.files[0]) {
            formData.append('file', fileInput.files[0]);
        }

        try {
            const response = await fetch(`/api/images/${imageId}/update`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const from = new URLSearchParams(window.location.search).get('from');
                if (from === 'admin') {
                    window.location.href = '/admin';
                } else {
                    window.location.href = '/profile';
                }
            } else {
                const errorText = await response.text();
                showError('Ошибка при обновлении: ' + errorText);
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Ошибка сети: ' + error.message);
        }
    });

    // Загружаем категории при старте
    document.addEventListener('DOMContentLoaded', loadCategories);
</script>
</body>
</html>